<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>小米路由器mini折腾之自动翻墙篇 | 老高的技术博客</title><meta name=keywords content="shadowsocks,router,redsocks,chinadns,xiaomi,pandorabox,openwrt"><meta name=description content="趁着节假日，终于搞定了路由器的自动翻墙，终于有自己的翻墙路由器了，之后一发而不可收，记录了一些折腾的文章，索引在此
openwrt路由器折腾教程索引
附赠 翻越功夫网教程索引
自从发现Pandorabox在r355版在固件中整合了ss，redsocks2和ChinaDNS-C，省下了不少事儿。
有同学反应r355-20150114被移除，刚好老高有存货，文中有百度网盘下载
本教程同样适用于其他openwrt系统。
推荐查看更好的方案一节！
你可能根据一下关键词找到此文章：

pandorabox openwrt 安装redsocks2
翻墙路由器
路由器翻墙教程
pandorabox openwrt 路由器翻墙
小米路由器翻墙 教程
打造自动翻墙的路由器
设置路由器翻墙
"><meta name=author content="Me"><link rel=canonical href=https://phpgao.github.io/carzy_router.html><link crossorigin=anonymous href=/assets/css/stylesheet.min.1a6ee89730e13a801d0f34e0cb5b98e96cf8c65b80500638bd599fc224ed8442.css integrity="sha256-Gm7olzDhOoAdDzTgy1uY6Wz4xluAUAY4vVmfwiTthEI=" rel="preload stylesheet" as=style><link rel=preload href="https://cdn.v2ex.com/gravatar/2b66f45a3e2f41db6522381006bfaea1?s=192" as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://phpgao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://phpgao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://phpgao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://phpgao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://phpgao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-39288145-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="小米路由器mini折腾之自动翻墙篇"><meta property="og:description" content="趁着节假日，终于搞定了路由器的自动翻墙，终于有自己的翻墙路由器了，之后一发而不可收，记录了一些折腾的文章，索引在此
openwrt路由器折腾教程索引
附赠 翻越功夫网教程索引
自从发现Pandorabox在r355版在固件中整合了ss，redsocks2和ChinaDNS-C，省下了不少事儿。
有同学反应r355-20150114被移除，刚好老高有存货，文中有百度网盘下载
本教程同样适用于其他openwrt系统。
推荐查看更好的方案一节！
你可能根据一下关键词找到此文章：

pandorabox openwrt 安装redsocks2
翻墙路由器
路由器翻墙教程
pandorabox openwrt 路由器翻墙
小米路由器翻墙 教程
打造自动翻墙的路由器
设置路由器翻墙
"><meta property="og:type" content="article"><meta property="og:url" content="https://phpgao.github.io/carzy_router.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-01-04T14:47:00+00:00"><meta property="article:modified_time" content="2015-01-04T14:47:00+00:00"><meta property="og:site_name" content="老高的技术博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="小米路由器mini折腾之自动翻墙篇"><meta name=twitter:description content="趁着节假日，终于搞定了路由器的自动翻墙，终于有自己的翻墙路由器了，之后一发而不可收，记录了一些折腾的文章，索引在此
openwrt路由器折腾教程索引
附赠 翻越功夫网教程索引
自从发现Pandorabox在r355版在固件中整合了ss，redsocks2和ChinaDNS-C，省下了不少事儿。
有同学反应r355-20150114被移除，刚好老高有存货，文中有百度网盘下载
本教程同样适用于其他openwrt系统。
推荐查看更好的方案一节！
你可能根据一下关键词找到此文章：

pandorabox openwrt 安装redsocks2
翻墙路由器
路由器翻墙教程
pandorabox openwrt 路由器翻墙
小米路由器翻墙 教程
打造自动翻墙的路由器
设置路由器翻墙
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://phpgao.github.io/posts/"},{"@type":"ListItem","position":2,"name":"小米路由器mini折腾之自动翻墙篇","item":"https://phpgao.github.io/carzy_router.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"小米路由器mini折腾之自动翻墙篇","name":"小米路由器mini折腾之自动翻墙篇","description":"趁着节假日，终于搞定了路由器的自动翻墙，终于有自己的翻墙路由器了，之后一发而不可收，记录了一些折腾的文章，索引在此\nopenwrt路由器折腾教程索引\n附赠 翻越功夫网教程索引\n自从发现Pandorabox在r355版在固件中整合了ss，redsocks2和ChinaDNS-C，省下了不少事儿。\n有同学反应r355-20150114被移除，刚好老高有存货，文中有百度网盘下载\n本教程同样适用于其他openwrt系统。\n推荐查看更好的方案一节！\n你可能根据一下关键词找到此文章：\n pandorabox openwrt 安装redsocks2 翻墙路由器 路由器翻墙教程 pandorabox openwrt 路由器翻墙 小米路由器翻墙 教程 打造自动翻墙的路由器 设置路由器翻墙 ","keywords":["shadowsocks","router","redsocks","chinadns","xiaomi","pandorabox","openwrt"],"articleBody":"趁着节假日，终于搞定了路由器的自动翻墙，终于有自己的翻墙路由器了，之后一发而不可收，记录了一些折腾的文章，索引在此\nopenwrt路由器折腾教程索引\n附赠 翻越功夫网教程索引\n自从发现Pandorabox在r355版在固件中整合了ss，redsocks2和ChinaDNS-C，省下了不少事儿。\n有同学反应r355-20150114被移除，刚好老高有存货，文中有百度网盘下载\n本教程同样适用于其他openwrt系统。\n推荐查看更好的方案一节！\n你可能根据一下关键词找到此文章：\n pandorabox openwrt 安装redsocks2 翻墙路由器 路由器翻墙教程 pandorabox openwrt 路由器翻墙 小米路由器翻墙 教程 打造自动翻墙的路由器 设置路由器翻墙   重要更新 感谢@Question提醒\n刷完系统后配置好chinadns后，将wan6接口的协议切换成6to4协议，保存后可直连 ipv6.google.com，貌似DNS污染也一并解决了，但是不知为何直连速度不快，不如走SS。\n准备工作 shadowsocks shadowsocks是目前扶墙利器，原理是通过一台自由的服务器做sock5代理，将你的请求都转发到服务器，服务器会把你需要的内容加密返回给你，安全又稳定。\n如果你需要自己搭建一个，有下面的教程供你参考，VPS通用。\n不到30元使用一年，超性价比扶墙VPS\n使用shadowsocks轻松搭建FQ环境\n这里可以试用 免费shadowsocks\n智能路由器 随着小米路由器的发布，想要入手一个入门的智能路由器(能刷openwrt、dd-wrt等基于Linux可定制系统)，就很方便快捷了。而且刷机简单，机器性价比也不错。此文不仅适用于小米路由器，还有很多路由器都可以参考此文，如百度的newifi、极路由等。\n如果现在要购买小米路由器，网友@Yacyin有以下建议：\n 还有就是江浙沪的朋友，最好买易迅的版本，京东的版本是4月份的，做工明显糙很多，符合小米一贯质次价高的特点，要不是现在不好更新，我肯定买极路由2S了\n  刷机\n小米路由器如何刷机请参考小米路由器刷潘多拉固件教程 和 潘多拉固件下载地址，等开启了路由器SSH权限后我们就可以开始刷机了！\n 有些固件版本你可能找不到了，老高这儿还有存货。链接: 链接: http://pan.baidu.com/s/1mgnBcIc 密码: yvi7\n 刷机注意\n 注意千万不能用官方的刷机方法，把PandoraBox重命名为xxx.bin，然后插U盘刷机，刷完你会哭的。 正确的步骤是官方固件开启ssh后使用命令刷机\n 最后就是刷机了，刷机的命令在下面，其中/tmp/PandoraBox-ralink-xiaomi-mini-r327-20141226.bin是刷机包的文件名。\nmtd -r write /tmp/PandoraBox-ralink-xiaomi-mini-r327-20141226.bin firmware # garu同学反应以上命令无法刷机，如果出现类似情况，请使用以下命令刷 mtd -r write /tmp/PandoraBox-ralink-xiaomi-mini-r327-20141226.bin OS1 科学上个网配置 刷完机器的路由器就有以下技能，不过技能可能随着你刷的版本而变，目前(20150526)还是建议刷稳定版(stable)，版本号r512。\n其中shadowsocks负责代理，是搬运工； ChinaDNS负责解析域名，防止DNS污染，功夫网最近升级，目测ChinaDNS工作起来不太稳定； 最后的redsocks2负责判断线路是否正常，否则走代理访问，即自动翻墙，redsocks2是目前比较只能的扶墙工具，但是缺点也很明显，你会感到明显的网络延迟，不推荐玩游戏等对延迟有高要求的用户使用。\n废话真多，赶紧进入正题吧！\n opkg源 opkg类似centos的yum，Ubuntu的apt-get，我们用它安装编译好的软件，省时省力。想要自己编译对应平台的软件，请参考编译小米路由mini的openwrt固件。\n配置opkg这一步需要十分重要，后续的很多操作都依赖此项，针对小米或同种类的CPUMTK MT7620A，我们可以在pandorabox的后台位于 系统-软件包-配置。\n配置方法可以参考小米路由器mini折腾之配置opkg篇。\n 配置好opkg后可以点击刷新列表来更新软件列表，也可以在后台运行命令 opkg update\n 注意，更新完毕后一定解决的问题——-安装libc。否则会遇到类似下面的错误！\n satisfy_dependencies_for: Cannot satisfy the following dependencies for redsocks2:libc * libc *\n 配置shadowsocks客户端 shadowsocks的服务端配置也很简单，请参考使用shadowsocks轻松搭建FQ环境。\n下面我们主要将客户端的配置\n当我们在远程服务器配置完毕后 或者 购买他人提供的shadowsocks服务后，我们能够得到以下配置：\n ip-服务器IP地址 prot-服务器开放的端口号 密码-服务器验证密码 method-加密方式  有了以上信息，我们可以开始基本配置，如下图：\n下面我们开启本地sock5代理，以供测试配置是否生效，设置如下图：\n这两步配置相当于运行了以下命令(ss-local是客户端的命令行工具)\n/usr/bin/ss-local -s 11.11.11.11 -p 12345 -l 1080 -m des-cfb -k passwd -u -f /var/run/ss-local.pid  最重要的一步在此，请注意\n透明代理如何配置？\n透明代理即默认将所有数据请求都转发给ss完成，然而这样做会浪费流量，所以我们开启IP白名单（white list），IP白名单中全是中国的IP，在白名单中的IP不会转发至代理服务器，保证了访问速度，节省了流量，并基本实现了自动翻墙。\n此方法的缺点是不够只能，IP白名单需要经常升级。\n此配置的难点是如何获取国内IP段，我们使用如下简单的技巧可以获取最新的国内IP段。\n ps.IP白名单利用了dnsmasq中的ipset\n # 从ftp中获取中国IP段 curl 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | grep ipv4 | grep CN | awk -F\\| '{ printf(\"%s/%d\\n\", $4, 32-log($5)/log(2)) }'  /etc/chinadns_chnroute.txt 以上的命令会把数据保存在/etc/chinadns_chnroute.txt中，而ChinaDNS-C的菜单中会读取这一文本，所以我们只要移步至ChinaDNS-C菜单并拷贝ChinaDNS-C里的信息至shadowsocks透明代理的IP白名单中即可！如果没有luci界面的同学可以使用scp命令将/etc/chinadns_chnroute.txt导出再复制粘贴。\n最终的配置如下图：\nChinaDNS ChinaDNS需要指定国内IP和污染IP段，需要使用脚本定期更新维护，否则可能会出现解析异常。\n通过后台执行ps|grep chinadns，找到chinadns使用的资源文件。\n chinadns -l /etc/chinadns_iplist.txt -c /etc/chinadns_chnroute.txt -d -p 1053 -s 114.114.114.114,8.8.8.8\n 下面是更新命令，可以作为计划任务运行，计划任务位于 系统 --- 计划任务\n# 安装curl opkg install curl # 手动更新 curl 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | grep ipv4 | grep CN | awk -F\\| '{ printf(\"%s/%d\\n\", $4, 32-log($5)/log(2)) }'  /etc/chinadns_chnroute.txt # 自动更新 # 每天凌晨4点更新文件，注意文件路径 0 4 * * * curl 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | grep ipv4 | grep CN | awk -F\\| '{ printf(\"%s/%d\\n\", $4, 32-log($5)/log(2)) }'  /etc/chinadns_chnroute.txt 更高级的配置可以参考OpenWrt-dist的Wiki里面的DNS篇。\n老高的设置\n检查命令，192.168.1.1为路由器IP，1053为ChinaDNS的端口。\ndig @192.168.1.1 www.phpgao.com -p1053 redsock2 更多redsocks2的配置可以参考小米路由器mini折腾之redsocks2的配置篇\n前面的配置基本能够满足自动翻墙的需要了，但是使用ss白名单的不好之处就是国内IP需要定时更新，否则可能造成由于IP判断错误而打不开网页的情况，那么如果我很懒，不想经常去更新IP表，有什么更好的解决方案吗？\n答案是有的。\nredsocks2实现了自动翻墙，原理是先由iptables转发所有tcp请求至预先设定的端口，然后程序会尝试访问目标，如果在指定的时间内服务器有反应，那么就继续完成请求，否则让此次请求走代理线路，所以需要ss的配合。\n由于有些版本的固件移除了redsocks2，我们需要把他找回来，以下是找回的方法：\n# 安装redsocks2 opkg install redsocks2 # 安装redsocks2后台luci菜单 cd /tmp # wget 如果404，请移步 http://sourceforge.net/projects/openwrt-dist/files/luci-app/redsocks2/ 自己下载ipk，然后安装 wget http://iweb.dl.sourceforge.net/project/openwrt-dist/luci-app/redsocks2/luci-app-redsocks2_1.3.0-1_all.ipk opkg install luci-app-redsocks2_1.3.0-1_all.ipk redsocks2运行后会修改系统的防火墙。\n图片说明：所有非内网的tcp流量都转发至1081端口，当然，这些工作都是后台自动完成的。\nredsock2的具体配置说明如下图，当然你还可以参考小米路由器mini折腾之redsocks2的配置篇。\n效果图如下，不需要在手机上做任何设置\n更好的方案 shadowsocks-libev-spec是shadowsocks-libev针对openwrt的优化版本，其中UDP转发可以彻底解决DNS污染问题，自动翻墙的配置更加简单，只需要配置好shadowsocks-libev-spec就可以实现！\n请参考下面的链接⬇️\n小米路由器mini折腾之安装shadowsocks-libev-spec\n远程访问 小米论坛有一篇讲开启8080端口的教程，玩转路由：开启Lamp,用小米路由器抢建你的私人博客\n其中最重要的就是这个：\nvi /etc/config/firewall # ADD config rule 'httpdwan' option src 'wan' option dest_port '8088' option proto 'tcp' option target 'ACCEPT' option name ''\\''httpd wan accept tcp port 8088'\\''' 这样就开启了8080，配合DDNS就可以完美远程管理路由器了\n具体想到的就这么多了，有什么疑问请留言。\nFAQ  安装某个软件时总是提示类似libc libgcc找不到？\n 请参考小米路由器mini折腾之配置opkg篇 文末。\n 我的界面怎么和你的不一样？\n 系统 - 语言和界面 - 主题 改成 Bookstrap，默认的是Luci\n 新版固件内核不兼容？还是换回稳定版吧。\n r858 Linux PandoraBox 3.14.42 #1 Sun May 17 20:39:27 CST 2015 mips GNU/Linux r820 Linux PandoraBox 3.14.40 #1 Wed May 13 20:38:46 CST 2015 mips GNU/Linux r512 Linux PandoraBox 3.10.70 #15 Mon Mar 9 19:33:59 CST 2015 mips GNU/Linux 2015年01月17日更：\n潘多拉小米mini版已升级到stable，推荐更新。下载地址：\nhttp://downloads.openwrt.org.cn/PandoraBox/Xiaomi-Mini-R1CM/stable/\n2015年02月12日更：\nresocks2的安装和使用\n2015年03月04日更：\n补充被删除的固件PandoraBox-ralink-xiaomi-mini-r355-20150114\nPandoraBox-ralink-xiaomi-mini-r355-20150114.bin\n2015年04月13日更：\n更好的方案一节。\n2015年05月26日更：\n重铸此文。\n","wordCount":"352","inLanguage":"en","datePublished":"2015-01-04T14:47:00Z","dateModified":"2015-01-04T14:47:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://phpgao.github.io/carzy_router.html"},"publisher":{"@type":"Organization","name":"老高的技术博客","logo":{"@type":"ImageObject","url":"https://phpgao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://phpgao.github.io/ accesskey=h title="老高的博客 (Alt + H)">老高的博客</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://phpgao.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://phpgao.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://blog.phpgao.com title="old blog"><span>old blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://phpgao.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://phpgao.github.io/posts/>Posts</a></div><h1 class=post-title>小米路由器mini折腾之自动翻墙篇</h1><div class=post-meta>January 4, 2015&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/2015-01-04_carzy_router.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>趁着节假日，终于搞定了路由器的自动翻墙，终于有自己的翻墙路由器了，之后一发而不可收，记录了一些折腾的文章，索引在此</p><p><a href=https://blog.phpgao.com/xiaomi_router.html>openwrt路由器折腾教程索引</a></p><p>附赠 <a href=https://blog.phpgao.com/slip_across_gfw.html>翻越功夫网教程索引</a></p><p>自从发现Pandorabox在<code>r355版</code>在固件中整合了ss，redsocks2和ChinaDNS-C，省下了不少事儿。</p><p><strong>有同学反应r355-20150114被移除，刚好老高有存货，文中有百度网盘下载</strong></p><p><strong>本教程同样适用于其他openwrt系统</strong>。</p><p>推荐查看<strong>更好的方案</strong>一节！</p><p>你可能根据一下关键词找到此文章：</p><ul><li>pandorabox openwrt 安装redsocks2</li><li><strong>翻墙路由器</strong></li><li>路由器翻墙教程</li><li>pandorabox openwrt 路由器翻墙</li><li>小米路由器翻墙 教程</li><li>打造自动翻墙的路由器</li><li>设置路由器翻墙</li></ul><hr><h2 id=重要更新>重要更新<a hidden class=anchor aria-hidden=true href=#重要更新>#</a></h2><p>感谢@Question提醒</p><p>刷完系统后配置好chinadns后，将wan6接口的协议切换成6to4协议，保存后可直连 ipv6.google.com，貌似DNS污染也一并解决了，但是不知为何直连速度不快，不如走SS。</p><h2 id=准备工作>准备工作<a hidden class=anchor aria-hidden=true href=#准备工作>#</a></h2><h3 id=shadowsocks>shadowsocks<a hidden class=anchor aria-hidden=true href=#shadowsocks>#</a></h3><p>shadowsocks是目前扶墙利器，原理是通过一台<code>自由</code>的服务器做sock5代理，将你的请求都转发到服务器，服务器会把你需要的内容加密返回给你，安全又稳定。</p><p>如果你需要自己搭建一个，有下面的教程供你参考，VPS通用。</p><p><a href=https://blog.phpgao.com/vps.html>不到30元使用一年，超性价比扶墙VPS</a></p><p><a href=https://blog.phpgao.com/shadowsocks_on_linux.html>使用shadowsocks轻松搭建FQ环境</a></p><p>这里可以试用 <a href=https://blog.phpgao.com/try_shadowsocks_via_qrcode.html>免费shadowsocks</a></p><h3 id=智能路由器>智能路由器<a hidden class=anchor aria-hidden=true href=#智能路由器>#</a></h3><p>随着小米路由器的发布，想要入手一个入门的智能路由器(能刷openwrt、dd-wrt等基于Linux可定制系统)，就很方便快捷了。而且刷机简单，机器性价比也不错。此文不仅适用于小米路由器，还有很多路由器都可以参考此文，如百度的newifi、极路由等。</p><p>如果现在要购买小米路由器，网友@Yacyin有以下建议：</p><blockquote><p>还有就是江浙沪的朋友，最好买易迅的版本，京东的版本是4月份的，做工明显糙很多，符合小米一贯质次价高的特点，要不是现在不好更新，我肯定买极路由2S了</p></blockquote><hr><p><strong>刷机</strong></p><p>小米路由器如何刷机请参考<a href=http://www.miui.com/thread-2036705-1-1.html>小米路由器刷潘多拉固件教程</a> 和 <a href=http://downloads.openwrt.org.cn/PandoraBox/Xiaomi-Mini-R1CM/testing/>潘多拉固件下载地址</a>，等开启了路由器SSH权限后我们就可以开始刷机了！</p><blockquote><p>有些固件版本你可能找不到了，老高这儿还有存货。链接: 链接: <a href=http://pan.baidu.com/s/1mgnBcIc>http://pan.baidu.com/s/1mgnBcIc</a> 密码: yvi7</p></blockquote><p><strong>刷机注意</strong></p><blockquote><p>注意千万不能用官方的刷机方法，把PandoraBox重命名为xxx.bin，然后插U盘刷机，刷完你会哭的。
正确的步骤是官方固件开启ssh后使用命令刷机</p></blockquote><p><strong>最后</strong>就是刷机了，刷机的命令在下面，其中<code>/tmp/PandoraBox-ralink-xiaomi-mini-r327-20141226.bin</code>是刷机包的文件名。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mtd -r write /tmp/PandoraBox-ralink-xiaomi-mini-r327-20141226.bin firmware

<span style=color:#75715e># garu同学反应以上命令无法刷机，如果出现类似情况，请使用以下命令刷</span>
mtd -r write /tmp/PandoraBox-ralink-xiaomi-mini-r327-20141226.bin OS1
</code></pre></div><h2 id=科学上个网配置>科学上个网配置<a hidden class=anchor aria-hidden=true href=#科学上个网配置>#</a></h2><p>刷完机器的路由器就有以下<code>技能</code>，不过技能可能随着你刷的版本而变，目前(20150526)还是建议刷稳定版(stable)，版本号r512。</p><p><img loading=lazy src=http://ww4.sinaimg.cn/large/6735b7fatw1enw9m9pa5nj208u0gyaam.jpg alt=skill></p><p>其中shadowsocks负责代理，是搬运工；
ChinaDNS负责解析域名，防止DNS污染，功夫网最近升级，目测ChinaDNS工作起来不太稳定；
最后的redsocks2负责判断线路是否正常，否则走代理访问，即自动翻墙，redsocks2是目前比较只能的扶墙工具，但是缺点也很明显，你会感到明显的网络延迟，不推荐玩游戏等对延迟有高要求的用户使用。</p><p>废话真多，赶紧进入正题吧！</p><hr><h3 id=opkg源>opkg源<a hidden class=anchor aria-hidden=true href=#opkg源>#</a></h3><p><code>opkg</code>类似centos的<code>yum</code>，Ubuntu的<code>apt-get</code>，我们用它安装编译好的软件，省时省力。想要自己编译对应平台的软件，请参考<a href=https://blog.phpgao.com/xiaomi_router_openwrt.html>编译小米路由mini的openwrt固件</a>。</p><p>配置opkg这一步需要十分重要，后续的很多操作都依赖此项，针对小米或同种类的CPU<code>MTK MT7620A</code>，我们可以在pandorabox的后台位于 系统->软件包->配置。</p><p>配置方法可以参考<a href=https://blog.phpgao.com/xiaomi_router_opkg.html>小米路由器mini折腾之配置opkg篇</a>。</p><blockquote><p>配置好opkg后可以点击刷新列表来更新软件列表，也可以在后台运行命令 opkg update</p></blockquote><p><strong>注意</strong>，更新完毕后一定解决的问题&mdash;&mdash;-安装libc。否则会遇到类似下面的错误！</p><blockquote><p>satisfy_dependencies_for: Cannot satisfy the following dependencies for redsocks2:libc * libc *</p></blockquote><h3 id=配置shadowsocks客户端>配置shadowsocks客户端<a hidden class=anchor aria-hidden=true href=#配置shadowsocks客户端>#</a></h3><p>shadowsocks的服务端配置也很简单，请参考<a href=https://blog.phpgao.com/shadowsocks_on_linux.html>使用shadowsocks轻松搭建FQ环境</a>。</p><p><strong>下面我们主要将客户端的配置</strong></p><p>当我们在远程服务器配置完毕后 或者 购买他人提供的shadowsocks服务后，我们能够得到以下配置：</p><ol><li>ip->服务器IP地址</li><li>prot->服务器开放的端口号</li><li>密码->服务器验证密码</li><li>method->加密方式</li></ol><p>有了以上信息，我们可以开始基本配置，如下图：</p><p><img loading=lazy src=http://ww4.sinaimg.cn/large/6735b7fatw1eq24hkpo3sj20hs0cpab4.jpg alt=基本配置></p><p>下面我们开启本地sock5代理，以供测试配置是否生效，设置如下图：</p><p><img loading=lazy src=http://ww3.sinaimg.cn/large/6735b7fatw1eq260c9nd8j208w033t8k.jpg alt=本地代理设置></p><p>这两步配置相当于运行了以下命令(ss-local是客户端的命令行工具)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/usr/bin/ss-local -s 11.11.11.11 -p <span style=color:#ae81ff>12345</span> -l <span style=color:#ae81ff>1080</span> -m des-cfb -k passwd -u -f /var/run/ss-local.pid
</code></pre></div><hr><p><strong>最重要的一步在此，请注意</strong></p><p>透明代理如何配置？</p><p>透明代理即默认将所有数据请求都转发给ss完成，然而这样做会浪费流量，所以我们开启IP白名单（white list），IP白名单中全是中国的IP，在白名单中的IP不会转发至代理服务器，保证了访问速度，节省了流量，并基本实现了自动翻墙。</p><p><strong>此方法的缺点是不够只能，IP白名单需要经常升级。</strong></p><p>此配置的难点是如何获取国内IP段，我们使用如下简单的技巧可以获取最新的国内IP段。</p><blockquote><p>ps.IP白名单利用了dnsmasq中的ipset</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 从ftp中获取中国IP段</span>
curl <span style=color:#e6db74>&#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#39;</span> | grep ipv4 | grep CN | awk -F<span style=color:#ae81ff>\|</span> <span style=color:#e6db74>&#39;{ printf(&#34;%s/%d\n&#34;, $4, 32-log($5)/log(2)) }&#39;</span> &gt; /etc/chinadns_chnroute.txt
</code></pre></div><p>以上的命令会把数据保存在<code>/etc/chinadns_chnroute.txt</code>中，而ChinaDNS-C的菜单中会读取这一文本，所以我们只要移步至ChinaDNS-C菜单并拷贝<em>ChinaDNS-C</em>里的信息至shadowsocks透明代理的IP白名单中即可！如果没有luci界面的同学可以使用<code>scp</code>命令将/etc/chinadns_chnroute.txt导出再复制粘贴。</p><p>最终的配置如下图：</p><p><img loading=lazy src=http://ww4.sinaimg.cn/large/6735b7fatw1eq26k2sbbjj20d50dcaao.jpg alt=透明代理></p><h3 id=chinadns>ChinaDNS<a hidden class=anchor aria-hidden=true href=#chinadns>#</a></h3><p>ChinaDNS需要指定国内IP和污染IP段，需要使用脚本定期更新维护，否则可能会出现解析异常。</p><p>通过后台执行<code>ps|grep chinadns</code>，找到chinadns使用的资源文件。</p><blockquote><p>chinadns -l /etc/chinadns_iplist.txt -c /etc/chinadns_chnroute.txt -d -p 1053 -s 114.114.114.114,8.8.8.8</p></blockquote><p>下面是更新命令，可以作为计划任务运行，计划任务位于 <code>系统 ---> 计划任务</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 安装curl</span>

opkg install curl

<span style=color:#75715e># 手动更新</span>
curl <span style=color:#e6db74>&#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#39;</span> | grep ipv4 | grep CN | awk -F<span style=color:#ae81ff>\|</span> <span style=color:#e6db74>&#39;{ printf(&#34;%s/%d\n&#34;, $4, 32-log($5)/log(2)) }&#39;</span> &gt; /etc/chinadns_chnroute.txt

<span style=color:#75715e># 自动更新</span>
<span style=color:#75715e># 每天凌晨4点更新文件，注意文件路径</span>
<span style=color:#ae81ff>0</span> <span style=color:#ae81ff>4</span> * * * curl <span style=color:#e6db74>&#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#39;</span> | grep ipv4 | grep CN | awk -F<span style=color:#ae81ff>\|</span> <span style=color:#e6db74>&#39;{ printf(&#34;%s/%d\n&#34;, $4, 32-log($5)/log(2)) }&#39;</span> &gt; /etc/chinadns_chnroute.txt
</code></pre></div><p><img loading=lazy src=https://blog.phpgao.com/usr/uploads/2015/05/3816985260.png alt=计划任务更新ChinaDNS的IP段></p><p><strong>更高级的配置</strong>可以参考<a href=http://sourceforge.net/p/openwrt-dist/wiki/DNS/>OpenWrt-dist的Wiki</a>里面的DNS篇。</p><p>老高的设置</p><p><img loading=lazy src=http://ww4.sinaimg.cn/large/6735b7fatw1enyjs2vbs3j208r0dcq3f.jpg alt=chinadns配置></p><p>检查命令，192.168.1.1为路由器IP，1053为ChinaDNS的端口。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dig @192.168.1.1 www.phpgao.com -p1053
</code></pre></div><h3 id=redsock2>redsock2<a hidden class=anchor aria-hidden=true href=#redsock2>#</a></h3><p>更多redsocks2的配置可以参考<a href=https://blog.phpgao.com/redsocks_config.html>小米路由器mini折腾之redsocks2的配置篇</a></p><p>前面的配置基本能够满足自动翻墙的需要了，但是使用ss白名单的不好之处就是国内IP需要定时更新，否则可能造成由于IP判断错误而打不开网页的情况，那么如果我很懒，不想经常去更新IP表，有什么更好的解决方案吗？</p><p>答案是有的。</p><p>redsocks2实现了自动翻墙，原理是先由iptables转发所有tcp请求至预先设定的端口，然后程序会尝试访问目标，如果在指定的时间内服务器有反应，那么就继续完成请求，否则让此次请求走代理线路，所以需要ss的配合。</p><p>由于有些版本的固件移除了redsocks2，我们需要把他找回来，以下是找回的方法：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 安装redsocks2</span>
opkg install redsocks2
<span style=color:#75715e># 安装redsocks2后台luci菜单</span>
cd /tmp
<span style=color:#75715e># wget 如果404，请移步 http://sourceforge.net/projects/openwrt-dist/files/luci-app/redsocks2/ 自己下载ipk，然后安装</span>
wget http://iweb.dl.sourceforge.net/project/openwrt-dist/luci-app/redsocks2/luci-app-redsocks2_1.3.0-1_all.ipk
opkg install luci-app-redsocks2_1.3.0-1_all.ipk
</code></pre></div><p>redsocks2运行后会修改系统的防火墙。</p><p><img loading=lazy src=http://ww4.sinaimg.cn/large/6735b7fatw1enyjy47watj20m80ddwg2.jpg alt=iptables配置></p><p>图片说明：所有非内网的tcp流量都转发至1081端口，当然，这些工作都是后台自动完成的。</p><p>redsock2的具体配置说明如下图，当然你还可以参考<a href=https://blog.phpgao.com/redsocks_config.html>小米路由器mini折腾之redsocks2的配置篇</a>。</p><p><img loading=lazy src=http://ww1.sinaimg.cn/large/6735b7fatw1ep6xh17vo9j20ce0dc75c.jpg alt=redsock2的配置></p><p>效果图如下，不需要在手机上做任何设置</p><p><img loading=lazy src=http://ww3.sinaimg.cn/large/6735b7fatw1epy2vbgkdxj20690b4wew.jpg alt=redsocks2></p><h2 id=更好的方案>更好的方案<a hidden class=anchor aria-hidden=true href=#更好的方案>#</a></h2><p>shadowsocks-libev-spec是shadowsocks-libev针对openwrt的优化版本，其中UDP转发可以彻底解决DNS污染问题，自动翻墙的配置更加简单，只需要配置好shadowsocks-libev-spec就可以实现！</p><p>请参考下面的链接⬇️</p><p><a href=https://blog.phpgao.com/xiaomi_router_shadowsocks_libev_spec.html>小米路由器mini折腾之安装shadowsocks-libev-spec</a></p><h2 id=远程访问>远程访问<a hidden class=anchor aria-hidden=true href=#远程访问>#</a></h2><p>小米论坛有一篇讲开启8080端口的教程，<a href=http://www.miui.com/thread-1788492-1-1.html>玩转路由：开启Lamp,用小米路由器抢建你的私人博客</a></p><p>其中最重要的就是这个：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vi /etc/config/firewall

<span style=color:#75715e># ADD</span>
config rule <span style=color:#e6db74>&#39;httpdwan&#39;</span>
option src <span style=color:#e6db74>&#39;wan&#39;</span>
option dest_port <span style=color:#e6db74>&#39;8088&#39;</span>
option proto <span style=color:#e6db74>&#39;tcp&#39;</span>
option target <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
option name <span style=color:#e6db74>&#39;&#39;</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>&#39;httpd wan accept tcp port 8088&#39;</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>&#39;&#39;</span>
</code></pre></div><p>这样就开启了8080，配合<a href=https://blog.phpgao.com/xiaomi_router_ddns.html>DDNS</a>就可以完美远程管理路由器了</p><p>具体想到的就这么多了，有什么疑问请留言。</p><h2 id=faq>FAQ<a hidden class=anchor aria-hidden=true href=#faq>#</a></h2><blockquote><p>安装某个软件时总是提示类似<strong>libc libgcc</strong>找不到？</p></blockquote><p>请参考<a href=https://blog.phpgao.com/xiaomi_router_opkg.html>小米路由器mini折腾之配置opkg篇</a> 文末。</p><blockquote><p>我的界面怎么和你的不一样？</p></blockquote><p>系统 - 语言和界面 - 主题 改成 Bookstrap，默认的是Luci</p><blockquote><p>新版固件内核不兼容？还是换回稳定版吧。</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>r858
Linux PandoraBox 3.14.42 #1 Sun May 17 20:39:27 CST 2015 mips GNU/Linux

r820
Linux PandoraBox 3.14.40 #1 Wed May 13 20:38:46 CST 2015 mips GNU/Linux

r512
Linux PandoraBox 3.10.70 #15 Mon Mar 9 19:33:59 CST 2015 mips GNU/Linux
</code></pre></div><p>2015年01月17日更：</p><p>潘多拉小米mini版已升级到stable，推荐更新。下载地址：</p><p><a href=http://downloads.openwrt.org.cn/PandoraBox/Xiaomi-Mini-R1CM/stable/>http://downloads.openwrt.org.cn/PandoraBox/Xiaomi-Mini-R1CM/stable/</a></p><p>2015年02月12日更：</p><p>resocks2的安装和使用</p><p>2015年03月04日更：</p><p>补充被删除的固件PandoraBox-ralink-xiaomi-mini-r355-20150114</p><p><a href=http://pan.baidu.com/s/1bn3zeFX>PandoraBox-ralink-xiaomi-mini-r355-20150114.bin</a></p><p>2015年04月13日更：</p><p>更好的方案一节。</p><p>2015年05月26日更：</p><p>重铸此文。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://phpgao.github.io/tags/shadowsocks/>shadowsocks</a></li><li><a href=https://phpgao.github.io/tags/router/>router</a></li><li><a href=https://phpgao.github.io/tags/redsocks/>redsocks</a></li><li><a href=https://phpgao.github.io/tags/chinadns/>chinadns</a></li><li><a href=https://phpgao.github.io/tags/xiaomi/>xiaomi</a></li><li><a href=https://phpgao.github.io/tags/pandorabox/>pandorabox</a></li><li><a href=https://phpgao.github.io/tags/openwrt/>openwrt</a></li></ul><nav class=paginav><a class=prev href=https://phpgao.github.io/python_cli_options.html><span class=title>« Prev Page</span><br><span>python接受命令选项-h</span></a>
<a class=next href=https://phpgao.github.io/vps_iptables.html><span class=title>Next Page »</span><br><span>VPS安全之防火墙设置</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://phpgao.github.io/>老高的技术博客</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>