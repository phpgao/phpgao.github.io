<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>thinkphp钩子的实现 | 老高的技术博客</title><meta name=keywords content="thinkphp,hook"><meta name=description content="钩子概念对初学者来说可能比较抽象难懂，但是只要掌握了他的工作方式，那么自己动手写一个钩子机制也不难。
Hook这个词很有意思，以下引用自某网络词典：

Hook用作名词时意思是“钩”,转化为动词时可表示把某物弯成钩形,也可表示用弯曲的东西把某物体钩住,引申可表示为“吊”“挂”等。

作为一个程序猿，老高对钩子的解释是，他就是一个触发机制，把你的软件功能想象成一个陷阱，放到##系统流程##可能经过的路上，如果陷阱被系统踩到，就会执行你的程序，当你挂载的钩子执行完后，系统会根据你的程序的结果继续运行。
老高最早接触Hook的编程思想是源于windows，当时打dota很入迷，突然想研究一下改键的原理，于是发现了系统钩子这一说法。
改键的原理，简单地说来就是拦截系统按下键盘时的默认动作，如果需要把小键盘的7映射到Q上，就在拦截时做一个判断，如果的键码是小键盘7，就改为Q的键码，最后发送给系统修改后的键码，即完成了改键操作。
钩子机制的使用在很多系统上都有体现，如windows、wordpress、thinkphp等，由钩子实现的功能在wordpress中叫做插件，在TP中叫做行为。"><meta name=author content="Me"><link rel=canonical href=https://phpgao.github.io/thinkphp_hook.html><link crossorigin=anonymous href=/assets/css/stylesheet.min.1a6ee89730e13a801d0f34e0cb5b98e96cf8c65b80500638bd599fc224ed8442.css integrity="sha256-Gm7olzDhOoAdDzTgy1uY6Wz4xluAUAY4vVmfwiTthEI=" rel="preload stylesheet" as=style><link rel=preload href="https://cdn.v2ex.com/gravatar/2b66f45a3e2f41db6522381006bfaea1?s=192" as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://phpgao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://phpgao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://phpgao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://phpgao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://phpgao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-39288145-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="thinkphp钩子的实现"><meta property="og:description" content="钩子概念对初学者来说可能比较抽象难懂，但是只要掌握了他的工作方式，那么自己动手写一个钩子机制也不难。
Hook这个词很有意思，以下引用自某网络词典：

Hook用作名词时意思是“钩”,转化为动词时可表示把某物弯成钩形,也可表示用弯曲的东西把某物体钩住,引申可表示为“吊”“挂”等。

作为一个程序猿，老高对钩子的解释是，他就是一个触发机制，把你的软件功能想象成一个陷阱，放到##系统流程##可能经过的路上，如果陷阱被系统踩到，就会执行你的程序，当你挂载的钩子执行完后，系统会根据你的程序的结果继续运行。
老高最早接触Hook的编程思想是源于windows，当时打dota很入迷，突然想研究一下改键的原理，于是发现了系统钩子这一说法。
改键的原理，简单地说来就是拦截系统按下键盘时的默认动作，如果需要把小键盘的7映射到Q上，就在拦截时做一个判断，如果的键码是小键盘7，就改为Q的键码，最后发送给系统修改后的键码，即完成了改键操作。
钩子机制的使用在很多系统上都有体现，如windows、wordpress、thinkphp等，由钩子实现的功能在wordpress中叫做插件，在TP中叫做行为。"><meta property="og:type" content="article"><meta property="og:url" content="https://phpgao.github.io/thinkphp_hook.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-09-29T02:22:00+00:00"><meta property="article:modified_time" content="2014-09-29T02:22:00+00:00"><meta property="og:site_name" content="老高的技术博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="thinkphp钩子的实现"><meta name=twitter:description content="钩子概念对初学者来说可能比较抽象难懂，但是只要掌握了他的工作方式，那么自己动手写一个钩子机制也不难。
Hook这个词很有意思，以下引用自某网络词典：

Hook用作名词时意思是“钩”,转化为动词时可表示把某物弯成钩形,也可表示用弯曲的东西把某物体钩住,引申可表示为“吊”“挂”等。

作为一个程序猿，老高对钩子的解释是，他就是一个触发机制，把你的软件功能想象成一个陷阱，放到##系统流程##可能经过的路上，如果陷阱被系统踩到，就会执行你的程序，当你挂载的钩子执行完后，系统会根据你的程序的结果继续运行。
老高最早接触Hook的编程思想是源于windows，当时打dota很入迷，突然想研究一下改键的原理，于是发现了系统钩子这一说法。
改键的原理，简单地说来就是拦截系统按下键盘时的默认动作，如果需要把小键盘的7映射到Q上，就在拦截时做一个判断，如果的键码是小键盘7，就改为Q的键码，最后发送给系统修改后的键码，即完成了改键操作。
钩子机制的使用在很多系统上都有体现，如windows、wordpress、thinkphp等，由钩子实现的功能在wordpress中叫做插件，在TP中叫做行为。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://phpgao.github.io/posts/"},{"@type":"ListItem","position":2,"name":"thinkphp钩子的实现","item":"https://phpgao.github.io/thinkphp_hook.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"thinkphp钩子的实现","name":"thinkphp钩子的实现","description":"钩子概念对初学者来说可能比较抽象难懂，但是只要掌握了他的工作方式，那么自己动手写一个钩子机制也不难。\nHook这个词很有意思，以下引用自某网络词典：\n Hook用作名词时意思是“钩”,转化为动词时可表示把某物弯成钩形,也可表示用弯曲的东西把某物体钩住,引申可表示为“吊”“挂”等。\n 作为一个程序猿，老高对钩子的解释是，他就是一个触发机制，把你的软件功能想象成一个陷阱，放到##系统流程##可能经过的路上，如果陷阱被系统踩到，就会执行你的程序，当你挂载的钩子执行完后，系统会根据你的程序的结果继续运行。\n老高最早接触Hook的编程思想是源于windows，当时打dota很入迷，突然想研究一下改键的原理，于是发现了系统钩子这一说法。\n改键的原理，简单地说来就是拦截系统按下键盘时的默认动作，如果需要把小键盘的7映射到Q上，就在拦截时做一个判断，如果的键码是小键盘7，就改为Q的键码，最后发送给系统修改后的键码，即完成了改键操作。\n钩子机制的使用在很多系统上都有体现，如windows、wordpress、thinkphp等，由钩子实现的功能在wordpress中叫做插件，在TP中叫做行为。\n","keywords":["thinkphp","hook"],"articleBody":"钩子概念对初学者来说可能比较抽象难懂，但是只要掌握了他的工作方式，那么自己动手写一个钩子机制也不难。\nHook这个词很有意思，以下引用自某网络词典：\n Hook用作名词时意思是“钩”,转化为动词时可表示把某物弯成钩形,也可表示用弯曲的东西把某物体钩住,引申可表示为“吊”“挂”等。\n 作为一个程序猿，老高对钩子的解释是，他就是一个触发机制，把你的软件功能想象成一个陷阱，放到##系统流程##可能经过的路上，如果陷阱被系统踩到，就会执行你的程序，当你挂载的钩子执行完后，系统会根据你的程序的结果继续运行。\n老高最早接触Hook的编程思想是源于windows，当时打dota很入迷，突然想研究一下改键的原理，于是发现了系统钩子这一说法。\n改键的原理，简单地说来就是拦截系统按下键盘时的默认动作，如果需要把小键盘的7映射到Q上，就在拦截时做一个判断，如果的键码是小键盘7，就改为Q的键码，最后发送给系统修改后的键码，即完成了改键操作。\n钩子机制的使用在很多系统上都有体现，如windows、wordpress、thinkphp等，由钩子实现的功能在wordpress中叫做插件，在TP中叫做行为。\n 老高认为，钩子在MVC模式下十分重要，他实现了在不改变源代码的前提下提升系统的灵活性，如，在文章输出前打印版权信息，在文章输出后生成二维码信息，app运行前检查用户权限，还有更多产品经理提出的变态要求，都可以\n 掌握了钩子的原理后，那么实现起来就很简单了，TP只花了不到100行代码就搞定了，下面我们分析一下：\n首先，我们要明确一些说法。在TP中，设置陷阱的过程称为##绑定事件##，而某个事件触发的功能函数称为##行为##。\n钩子应该具有的基本方法应该有：\n 设置钩子（导入钩子） 触发事件 执行行为  首先我们看看TP是怎么写的，源代码位于ThinkPHP/Library/Think/Hook.class.php，Hook类中全是静态方法，其中有唯一静态属性$tags，他是一个数组，键为绑定的事件，值为绑定的行为。\n其中有两个方法可以用于绑定，前者是单个，后者是是批量。\nstatic public function add($tag,$name) { echo $tag; echo \"\\n\"; if(!isset(self::$tags[$tag])){ self::$tags[$tag] = array(); } if(is_array($name)){ self::$tags[$tag] = array_merge(self::$tags[$tag],$name); }else{ self::$tags[$tag][] = $name; } } static public function import($data,$recursive=true) { if(!$recursive){ // 覆盖导入  self::$tags = array_merge(self::$tags,$data); }else{ // 合并导入  foreach ($data as $tag=$val){ if(!isset(self::$tags[$tag])) self::$tags[$tag] = array(); if(!empty($val['_overlay'])){ // 可以针对某个标签指定覆盖模式  unset($val['_overlay']); self::$tags[$tag] = $val; }else{ // 合并模式  self::$tags[$tag] = array_merge(self::$tags[$tag],$val); } } } } 当系统触发了某个事件，比如app_start事件，TP会找到Hook::listen方法，该方法会查找$tags中有没有绑定app_start事件的方法，然后用foreach遍历$tags属性，并执行Hook:exec方法。\nstatic public function listen($tag, \u0026$params=NULL) { if(isset(self::$tags[$tag])) { if(APP_DEBUG) { G($tag.'Start'); trace('[ '.$tag.' ] --START--','','INFO'); } foreach (self::$tags[$tag] as $name) { APP_DEBUG \u0026\u0026 G($name.'_start'); $result = self::exec($name, $tag,$params); if(APP_DEBUG){ G($name.'_end'); trace('Run '.$name.' [ RunTime:'.G($name.'_start',$name.'_end',6).'s ]','','INFO'); } if(false === $result) { // 如果返回false 则中断插件执行  return ; } } if(APP_DEBUG) { // 记录行为的执行日志  trace('[ '.$tag.' ] --END-- [ RunTime:'.G($tag.'Start',$tag.'End',6).'s ]','','INFO'); } } return; } Hook:exec方法会检查行为名称，如果包含Behavior关键字，那么入口方法必须为run方法，而执行run方法的参数在调用Hook::listen时指定。但如果不用##Behavior##关键字做配置，即将系统默认的ReadHtmlCacheBehavior改为ReadHtml，系统会报错吗？答案是会的！\n如果去掉Behavior，系统就会找该类中绑定事件名称的方法，即app_begin。这样的好处是，不会强制使用run方法，一个行为可以复用了。\nstatic public function exec($name, $tag,\u0026$params=NULL) { if('Behavior' == substr($name,-8) ){ // 行为扩展必须用run入口方法  $tag = 'run'; } $addon = new $name(); return $addon-$tag($params); } ","wordCount":"167","inLanguage":"en","datePublished":"2014-09-29T02:22:00Z","dateModified":"2014-09-29T02:22:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://phpgao.github.io/thinkphp_hook.html"},"publisher":{"@type":"Organization","name":"老高的技术博客","logo":{"@type":"ImageObject","url":"https://phpgao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://phpgao.github.io/ accesskey=h title="老高的博客 (Alt + H)">老高的博客</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://phpgao.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://phpgao.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://blog.phpgao.com title="old blog"><span>old blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://phpgao.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://phpgao.github.io/posts/>Posts</a></div><h1 class=post-title>thinkphp钩子的实现</h1><div class=post-meta>September 29, 2014&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/2014-09-29_thinkphp_hook.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>钩子概念对初学者来说可能比较抽象难懂，但是只要掌握了他的工作方式，那么自己动手写一个钩子机制也不难。</p><p>Hook这个词很有意思，以下引用自某网络词典：</p><blockquote><p>Hook用作名词时意思是“钩”,转化为动词时可表示把某物弯成钩形,也可表示用弯曲的东西把某物体钩住,引申可表示为“吊”“挂”等。</p></blockquote><p>作为一个程序猿，老高对钩子的解释是，他就是一个触发机制，把你的软件功能想象成一个陷阱，放到##系统流程##可能经过的路上，如果陷阱被系统踩到，就会执行你的程序，当你挂载的钩子执行完后，系统会根据你的程序的结果继续运行。</p><p>老高最早接触Hook的编程思想是源于windows，当时打dota很入迷，突然想研究一下改键的原理，于是发现了系统钩子这一说法。</p><p>改键的原理，简单地说来就是拦截系统按下键盘时的默认动作，如果需要把小键盘的7映射到Q上，就在拦截时做一个判断，如果的键码是小键盘7，就改为Q的键码，最后发送给系统修改后的键码，即完成了改键操作。</p><p>钩子机制的使用在很多系统上都有体现，如windows、wordpress、thinkphp等，由钩子实现的功能在wordpress中叫做插件，在TP中叫做行为。</p><blockquote><p>老高认为，钩子在MVC模式下十分重要，他实现了在不改变源代码的前提下提升系统的灵活性，如，在文章输出前打印版权信息，在文章输出后生成二维码信息，app运行前检查用户权限，还有更多产品经理提出的变态要求，都可以</p></blockquote><p>掌握了钩子的原理后，那么实现起来就很简单了，TP只花了不到100行代码就搞定了，下面我们分析一下：</p><p>首先，我们要明确一些说法。在TP中，设置陷阱的过程称为##绑定事件##，而某个事件触发的功能函数称为##行为##。</p><p>钩子应该具有的基本方法应该有：</p><ul><li>设置钩子（导入钩子）</li><li>触发事件</li><li>执行行为</li></ul><p>首先我们看看TP是怎么写的，源代码位于<code>ThinkPHP/Library/Think/Hook.class.php</code>，Hook类中全是静态方法，其中有唯一静态属性<code>$tags</code>，他是一个数组，键为绑定的事件，值为绑定的行为。</p><p>其中有两个方法可以用于绑定，前者是单个，后者是是批量。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>add</span>($tag,$name) {
        <span style=color:#66d9ef>echo</span> $tag;
        <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>isset</span>(<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag])){
            <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag]   <span style=color:#f92672>=</span>   <span style=color:#66d9ef>array</span>();
        }
        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>is_array</span>($name)){
            <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag]   <span style=color:#f92672>=</span>   <span style=color:#a6e22e>array_merge</span>(<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag],$name);
        }<span style=color:#66d9ef>else</span>{
            <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag][] <span style=color:#f92672>=</span>   $name;
        }
    }
    
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>import</span>($data,$recursive<span style=color:#f92672>=</span><span style=color:#66d9ef>true</span>) {
        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>$recursive){ <span style=color:#75715e>// 覆盖导入
</span><span style=color:#75715e></span>            <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags   <span style=color:#f92672>=</span>   <span style=color:#a6e22e>array_merge</span>(<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags,$data);
        }<span style=color:#66d9ef>else</span>{ <span style=color:#75715e>// 合并导入
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>foreach</span> ($data <span style=color:#66d9ef>as</span> $tag<span style=color:#f92672>=&gt;</span>$val){
                <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>isset</span>(<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag]))
                    <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag]   <span style=color:#f92672>=</span>   <span style=color:#66d9ef>array</span>();            
                <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#66d9ef>empty</span>($val[<span style=color:#e6db74>&#39;_overlay&#39;</span>])){
                    <span style=color:#75715e>// 可以针对某个标签指定覆盖模式
</span><span style=color:#75715e></span>                    <span style=color:#a6e22e>unset</span>($val[<span style=color:#e6db74>&#39;_overlay&#39;</span>]);
                    <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag]   <span style=color:#f92672>=</span>   $val;
                }<span style=color:#66d9ef>else</span>{
                    <span style=color:#75715e>// 合并模式
</span><span style=color:#75715e></span>                    <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag]   <span style=color:#f92672>=</span>   <span style=color:#a6e22e>array_merge</span>(<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag],$val);
                }
            }            
        }
    }
</code></pre></div><p>当系统触发了某个事件，比如app_start事件，TP会找到<code>Hook::listen</code>方法，该方法会查找$tags中有没有绑定app_start事件的方法，然后用foreach遍历$tags属性，并执行<code>Hook:exec</code>方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>listen</span>($tag, <span style=color:#f92672>&amp;</span>$params<span style=color:#f92672>=</span><span style=color:#66d9ef>NULL</span>) {
        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>isset</span>(<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag])) {
            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>APP_DEBUG</span>) {
                <span style=color:#a6e22e>G</span>($tag<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;Start&#39;</span>);
                <span style=color:#a6e22e>trace</span>(<span style=color:#e6db74>&#39;[ &#39;</span><span style=color:#f92672>.</span>$tag<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; ] --START--&#39;</span>,<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#e6db74>&#39;INFO&#39;</span>);
            }
            <span style=color:#66d9ef>foreach</span> (<span style=color:#a6e22e>self</span><span style=color:#f92672>::</span>$tags[$tag] <span style=color:#66d9ef>as</span> $name) {
                <span style=color:#a6e22e>APP_DEBUG</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>G</span>($name<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;_start&#39;</span>);
                $result <span style=color:#f92672>=</span>   <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>exec</span>($name, $tag,$params);
                <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>APP_DEBUG</span>){
                    <span style=color:#a6e22e>G</span>($name<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;_end&#39;</span>);
                    <span style=color:#a6e22e>trace</span>(<span style=color:#e6db74>&#39;Run &#39;</span><span style=color:#f92672>.</span>$name<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; [ RunTime:&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>G</span>($name<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;_start&#39;</span>,$name<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;_end&#39;</span>,<span style=color:#ae81ff>6</span>)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;s ]&#39;</span>,<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#e6db74>&#39;INFO&#39;</span>);
                }
                <span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>false</span> <span style=color:#f92672>===</span> $result) {
                    <span style=color:#75715e>// 如果返回false 则中断插件执行
</span><span style=color:#75715e></span>                    <span style=color:#66d9ef>return</span> ;
                }
            }
            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>APP_DEBUG</span>) { <span style=color:#75715e>// 记录行为的执行日志
</span><span style=color:#75715e></span>                <span style=color:#a6e22e>trace</span>(<span style=color:#e6db74>&#39;[ &#39;</span><span style=color:#f92672>.</span>$tag<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; ] --END-- [ RunTime:&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>G</span>($tag<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;Start&#39;</span>,$tag<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;End&#39;</span>,<span style=color:#ae81ff>6</span>)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;s ]&#39;</span>,<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#e6db74>&#39;INFO&#39;</span>);
            }
        }
        <span style=color:#66d9ef>return</span>;
    }
</code></pre></div><p>Hook:exec方法会检查行为名称，如果包含Behavior关键字，那么入口方法必须为run方法，而执行run方法的参数在调用<code>Hook::listen</code>时指定。但如果不用##Behavior##关键字做配置，即将系统默认的<code>ReadHtmlCacheBehavior</code>改为<code>ReadHtml</code>，系统会报错吗？答案是会的！</p><p>如果去掉<strong>Behavior</strong>，系统就会找该类中绑定事件名称的方法，即<code>app_begin</code>。这样的好处是，不会强制使用run方法，一个行为可以复用了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>exec</span>($name, $tag,<span style=color:#f92672>&amp;</span>$params<span style=color:#f92672>=</span><span style=color:#66d9ef>NULL</span>) {
        <span style=color:#66d9ef>if</span>(<span style=color:#e6db74>&#39;Behavior&#39;</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>substr</span>($name,<span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>) ){
            <span style=color:#75715e>// 行为扩展必须用run入口方法
</span><span style=color:#75715e></span>            $tag    <span style=color:#f92672>=</span>   <span style=color:#e6db74>&#39;run&#39;</span>;
        }
        $addon   <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> $name();
        <span style=color:#66d9ef>return</span> $addon<span style=color:#f92672>-&gt;</span>$tag($params);
    }
</code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://phpgao.github.io/tags/thinkphp/>thinkphp</a></li><li><a href=https://phpgao.github.io/tags/hook/>hook</a></li></ul><nav class=paginav><a class=prev href=https://phpgao.github.io/undefined_imagettftext.html><span class=title>« Prev Page</span><br><span>Call-to-undefined-function-imagettftext()解决方法</span></a>
<a class=next href=https://phpgao.github.io/thinkphp_beginning.html><span class=title>Next Page »</span><br><span>thinkphp框架解析1----只是一个开始</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://phpgao.github.io/>老高的技术博客</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>