<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>一个flag引发的惨案(memcached) | 老高的技术博客</title><meta name=keywords content="memcache,flag,danga"><meta name=description content="起因
老高最近在重构一个服务，流程中有一步需要将数据格式化后放入memcached中，改数据之后会被另一个服务消费。老高使用的Python的pymemcache包，调用add方法后没有错误。然后通知另一个JAVA服务来读数据，JAVA使用的包名为com.danga.MemCached。该服务接受到消费任务后就来找之前放在memecached中的数据，好的！问题来了。
JAVA用什么方法都读不到Python放进去的数据，但是JAVA自己放自己取是能读到的。
PYTHON同理，能够读到自己设置的数据，但是读取JAVA程序设置的值有乱码。
通过命令行设置的值JAVA读取有问题，Python没问题。
程序猿的直觉告诉我，肯定是库出了问题！"><meta name=author content="Me"><link rel=canonical href=https://phpgao.github.io/memcached_flag_error.html><link crossorigin=anonymous href=/assets/css/stylesheet.min.1a6ee89730e13a801d0f34e0cb5b98e96cf8c65b80500638bd599fc224ed8442.css integrity="sha256-Gm7olzDhOoAdDzTgy1uY6Wz4xluAUAY4vVmfwiTthEI=" rel="preload stylesheet" as=style><link rel=preload href="https://cdn.v2ex.com/gravatar/2b66f45a3e2f41db6522381006bfaea1?s=192" as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://phpgao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://phpgao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://phpgao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://phpgao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://phpgao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-39288145-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="一个flag引发的惨案(memcached)"><meta property="og:description" content="起因
老高最近在重构一个服务，流程中有一步需要将数据格式化后放入memcached中，改数据之后会被另一个服务消费。老高使用的Python的pymemcache包，调用add方法后没有错误。然后通知另一个JAVA服务来读数据，JAVA使用的包名为com.danga.MemCached。该服务接受到消费任务后就来找之前放在memecached中的数据，好的！问题来了。
JAVA用什么方法都读不到Python放进去的数据，但是JAVA自己放自己取是能读到的。
PYTHON同理，能够读到自己设置的数据，但是读取JAVA程序设置的值有乱码。
通过命令行设置的值JAVA读取有问题，Python没问题。
程序猿的直觉告诉我，肯定是库出了问题！"><meta property="og:type" content="article"><meta property="og:url" content="https://phpgao.github.io/memcached_flag_error.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-11-20T05:42:00+00:00"><meta property="article:modified_time" content="2019-11-20T05:42:00+00:00"><meta property="og:site_name" content="老高的技术博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="一个flag引发的惨案(memcached)"><meta name=twitter:description content="起因
老高最近在重构一个服务，流程中有一步需要将数据格式化后放入memcached中，改数据之后会被另一个服务消费。老高使用的Python的pymemcache包，调用add方法后没有错误。然后通知另一个JAVA服务来读数据，JAVA使用的包名为com.danga.MemCached。该服务接受到消费任务后就来找之前放在memecached中的数据，好的！问题来了。
JAVA用什么方法都读不到Python放进去的数据，但是JAVA自己放自己取是能读到的。
PYTHON同理，能够读到自己设置的数据，但是读取JAVA程序设置的值有乱码。
通过命令行设置的值JAVA读取有问题，Python没问题。
程序猿的直觉告诉我，肯定是库出了问题！"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://phpgao.github.io/posts/"},{"@type":"ListItem","position":2,"name":"一个flag引发的惨案(memcached)","item":"https://phpgao.github.io/memcached_flag_error.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"一个flag引发的惨案(memcached)","name":"一个flag引发的惨案(memcached)","description":"起因 老高最近在重构一个服务，流程中有一步需要将数据格式化后放入memcached中，改数据之后会被另一个服务消费。老高使用的Python的pymemcache包，调用add方法后没有错误。然后通知另一个JAVA服务来读数据，JAVA使用的包名为com.danga.MemCached。该服务接受到消费任务后就来找之前放在memecached中的数据，好的！问题来了。\nJAVA用什么方法都读不到Python放进去的数据，但是JAVA自己放自己取是能读到的。 PYTHON同理，能够读到自己设置的数据，但是读取JAVA程序设置的值有乱码。 通过命令行设置的值JAVA读取有问题，Python没问题。\n程序猿的直觉告诉我，肯定是库出了问题！\n","keywords":["memcache","flag","danga"],"articleBody":"起因 老高最近在重构一个服务，流程中有一步需要将数据格式化后放入memcached中，改数据之后会被另一个服务消费。老高使用的Python的pymemcache包，调用add方法后没有错误。然后通知另一个JAVA服务来读数据，JAVA使用的包名为com.danga.MemCached。该服务接受到消费任务后就来找之前放在memecached中的数据，好的！问题来了。\nJAVA用什么方法都读不到Python放进去的数据，但是JAVA自己放自己取是能读到的。 PYTHON同理，能够读到自己设置的数据，但是读取JAVA程序设置的值有乱码。 通过命令行设置的值JAVA读取有问题，Python没问题。\n程序猿的直觉告诉我，肯定是库出了问题！\n排查 通过之前将的测试结果，八成已经可以确定是库的问题了，但是应该从什么地方着手呢？当然是从源码了！\n先把pymemcache库的add方法代码贴出来，其中flags引起了老高的注意，虽然是可选参数，但是如果不设置这个值的话，默认为0，而且0值的意义也没有解释，在get方法中也没有具体看出flag的特殊用意！\ndef add(self, key, value, expire=0, noreply=None, flags=None): \"\"\" The memcached \"add\" command. Args: key: str, see class docs for details. value: str, see class docs for details. expire: optional int, number of seconds until the item is expired from the cache, or zero for no expiry (the default). noreply: optional bool, True to not wait for the reply (defaults to self.default_noreply). flags: optional int, arbitrary bit field used for server-specific flags Returns: If noreply is True, the return value is always True. Otherwise the return value is True if the value was stored, and False if it was not (because the key already existed). \"\"\" if noreply is None: noreply = self.default_noreply return self._store_cmd(b'add', {key: value}, expire, noreply, flags=flags)[key] 再看看com.danga.MemCached中获取key逻辑的部分代码\nString cmd = \"get \" + key + \"\\r\\n\"; log.debug(\"++++ memcache get command: \" + cmd); sock.write(cmd.getBytes()); sock.flush(); MapString, Object hm = new HashMap(); this.loadItems(sock, hm, asString); log.debug(\"++++ memcache: got back \" + hm.size() + \" results\"); sock.close(); return hm.get(key); # this.loadItems(sock, hm, asString); 方法 if ((flag \u0026 2) != 0) { .... } if ((flag \u0026 8) == 0) { .... } 果然，java程序在获取key对应的值的时候是通过判断flag的值进行不同的解码工作！搞清楚这个，那么问题就迎刃而解了！不过真的是这样吗？\n解决 虽然老高找到了原因，但是如何解决这个问题呢？具体还是要看代码！\nif ((flag \u0026 2) != 0) { try { GZIPInputStream gzi = new GZIPInputStream(new ByteArrayInputStream(buf)); ByteArrayOutputStream bos = new ByteArrayOutputStream(buf.length); byte[] tmp = new byte[2048]; int count; while((count = gzi.read(tmp)) != -1) { bos.write(tmp, 0, count); } buf = bos.toByteArray(); gzi.close(); } catch (IOException var17) { if (this.errorHandler != null) { this.errorHandler.handleErrorOnGet(this, var17, key); } log.error(\"++++ IOException thrown while trying to uncompress input stream for key: \" + key); log.error(var17.getMessage(), var17); throw new NestedIOException(\"++++ IOException thrown while trying to uncompress input stream for key: \" + key, var17); } } Object o; if ((flag \u0026 8) == 0) { if (!this.primitiveAsString \u0026\u0026 !asString) { try { o = NativeHandler.decode(buf); } catch (Exception var15) { if (this.errorHandler != null) { this.errorHandler.handleErrorOnGet(this, var15, key); } log.error(\"++++ Exception thrown while trying to deserialize for key: \" + key, var15); throw new NestedIOException(var15); } } else { log.info(\"++++ retrieving object and stuffing into a string.\"); o = new String(buf, this.defaultEncoding); } } else { ContextObjectInputStream ois = new ContextObjectInputStream(new ByteArrayInputStream(buf), this.classLoader); try { o = ois.readObject(); log.info(\"++++ deserializing \" + o.getClass()); } catch (ClassNotFoundException var16) { if (this.errorHandler != null) { this.errorHandler.handleErrorOnGet(this, var16, key); } log.error(\"++++ ClassNotFoundException thrown while trying to deserialize for key: \" + key, var16); throw new NestedIOException(\"+++ failed while trying to deserialize for key: \" + key, var16); } } 第一步，如果flag与2!=0，说明原来的数据被压缩，需要先解压。这一步我们需要确保Python放进去的数据是没有经过压缩的。\n第二步的流程比较复杂，用过分析，默认流程会调用o = NativeHandler.decode(buf);这一句。对应的方法为decode，其中b[0]==6就是作为字符串解析。这样的话我们只需要Python在放入数据的时候使用相同的方式即可！\npublic static Object decode(byte[] b) throws Exception { if (b.length  1) { return null; } else if (b[0] == 2) { return decodeBoolean(b); } else if (b[0] == 3) { return decodeInteger(b); } else if (b[0] == 6) { return decodeString(b); } else if (b[0] == 5) { return decodeCharacter(b); } else if (b[0] == 1) { return decodeByte(b); } else if (b[0] == 7) { return decodeStringBuffer(b); } else if (b[0] == 9) { return decodeShort(b); } else if (b[0] == 4) { return decodeLong(b); } else if (b[0] == 10) { return decodeDouble(b); } else if (b[0] == 8) { return decodeFloat(b); } else { return b[0] == 11 ? decodeDate(b) : null; } } 于是，下面的代码应运而生，完美解决问题，保持了数据兼容性！\nb\"\".join([bytes([6]), str.encode(data)]) ","wordCount":"540","inLanguage":"en","datePublished":"2019-11-20T05:42:00Z","dateModified":"2019-11-20T05:42:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://phpgao.github.io/memcached_flag_error.html"},"publisher":{"@type":"Organization","name":"老高的技术博客","logo":{"@type":"ImageObject","url":"https://phpgao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://phpgao.github.io/ accesskey=h title="老高的博客 (Alt + H)">老高的博客</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://phpgao.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://phpgao.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://blog.phpgao.com title="old blog"><span>old blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://phpgao.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://phpgao.github.io/posts/>Posts</a></div><h1 class=post-title>一个flag引发的惨案(memcached)</h1><div class=post-meta>November 20, 2019&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/2019-11-20_memcached_flag_error.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h2 id=起因>起因<a hidden class=anchor aria-hidden=true href=#起因>#</a></h2><p>老高最近在重构一个服务，流程中有一步需要将数据格式化后放入memcached中，改数据之后会被另一个服务消费。老高使用的Python的<code>pymemcache</code>包，调用add方法后没有错误。然后通知另一个JAVA服务来读数据，JAVA使用的包名为<code>com.danga.MemCached</code>。该服务接受到消费任务后就来找之前放在memecached中的数据，好的！问题来了。</p><p>JAVA用什么方法都读不到Python放进去的数据，但是JAVA自己放自己取是能读到的。
PYTHON同理，能够读到自己设置的数据，但是读取JAVA程序设置的值有乱码。
通过命令行设置的值JAVA读取有问题，Python没问题。</p><p>程序猿的直觉告诉我，肯定是库出了问题！</p><h2 id=排查>排查<a hidden class=anchor aria-hidden=true href=#排查>#</a></h2><p>通过之前将的测试结果，八成已经可以确定是库的问题了，但是应该从什么地方着手呢？当然是从源码了！</p><p>先把<code>pymemcache</code>库的add方法代码贴出来，其中flags引起了老高的注意，虽然是可选参数，但是如果不设置这个值的话，默认为0，而且0值的意义也没有解释，在get方法中也没有具体看出flag的特殊用意！</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(self, key, value, expire<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, noreply<span style=color:#f92672>=</span>None, flags<span style=color:#f92672>=</span>None):
    <span style=color:#e6db74>&#34;&#34;&#34;
</span><span style=color:#e6db74>    The memcached &#34;add&#34; command.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    Args:
</span><span style=color:#e6db74>        key: str, see class docs for details.
</span><span style=color:#e6db74>        value: str, see class docs for details.
</span><span style=color:#e6db74>        expire: optional int, number of seconds until the item is expired
</span><span style=color:#e6db74>                from the cache, or zero for no expiry (the default).
</span><span style=color:#e6db74>        noreply: optional bool, True to not wait for the reply (defaults to
</span><span style=color:#e6db74>                self.default_noreply).
</span><span style=color:#e6db74>        flags: optional int, arbitrary bit field used for server-specific
</span><span style=color:#e6db74>                flags
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    Returns:
</span><span style=color:#e6db74>        If noreply is True, the return value is always True. Otherwise the
</span><span style=color:#e6db74>        return value is True if the value was stored, and False if it was
</span><span style=color:#e6db74>        not (because the key already existed).
</span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
    <span style=color:#66d9ef>if</span> noreply <span style=color:#f92672>is</span> None:
        noreply <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>default_noreply
    <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_store_cmd(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;add&#39;</span>, {key: value}, expire, noreply,
                            flags<span style=color:#f92672>=</span>flags)[key]
</code></pre></div><p>再看看<code>com.danga.MemCached</code>中获取key逻辑的部分代码</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>String cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;get &#34;</span> <span style=color:#f92672>+</span> key <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\r\n&#34;</span><span style=color:#f92672>;</span>
log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;++++ memcache get command: &#34;</span> <span style=color:#f92672>+</span> cmd<span style=color:#f92672>);</span>
sock<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>());</span>
sock<span style=color:#f92672>.</span><span style=color:#a6e22e>flush</span><span style=color:#f92672>();</span>
Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> hm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>();</span>
<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadItems</span><span style=color:#f92672>(</span>sock<span style=color:#f92672>,</span> hm<span style=color:#f92672>,</span> asString<span style=color:#f92672>);</span>
log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;++++ memcache: got back &#34;</span> <span style=color:#f92672>+</span> hm<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; results&#34;</span><span style=color:#f92672>);</span>
sock<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
<span style=color:#66d9ef>return</span> hm<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>

<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadItems</span><span style=color:#f92672>(</span>sock<span style=color:#f92672>,</span> hm<span style=color:#f92672>,</span> asString<span style=color:#f92672>);</span> 方法

<span style=color:#a6e22e>if</span> <span style=color:#f92672>((</span>flag <span style=color:#f92672>&amp;</span> 2<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
  <span style=color:#f92672>....</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>flag <span style=color:#f92672>&amp;</span> 8<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
  <span style=color:#f92672>....</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>果然，java程序在获取key对应的值的时候是通过判断flag的值进行不同的解码工作！搞清楚这个，那么问题就迎刃而解了！不过真的是这样吗？</p><h2 id=解决>解决<a hidden class=anchor aria-hidden=true href=#解决>#</a></h2><p>虽然老高找到了原因，但是如何解决这个问题呢？具体还是要看代码！</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>flag <span style=color:#f92672>&amp;</span> 2<span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
        GZIPInputStream gzi <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GZIPInputStream<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>buf<span style=color:#f92672>));</span>
        ByteArrayOutputStream bos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayOutputStream<span style=color:#f92672>(</span>buf<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> tmp <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>2048<span style=color:#f92672>];</span>

        <span style=color:#66d9ef>int</span> count<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>while</span><span style=color:#f92672>((</span>count <span style=color:#f92672>=</span> gzi<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>tmp<span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            bos<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>tmp<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> count<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

        buf <span style=color:#f92672>=</span> bos<span style=color:#f92672>.</span><span style=color:#a6e22e>toByteArray</span><span style=color:#f92672>();</span>
        gzi<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException var17<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>errorHandler</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>errorHandler</span><span style=color:#f92672>.</span><span style=color:#a6e22e>handleErrorOnGet</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> var17<span style=color:#f92672>,</span> key<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;++++ IOException thrown while trying to uncompress input stream for key: &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>);</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>var17<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> var17<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NestedIOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;++++ IOException thrown while trying to uncompress input stream for key: &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>,</span> var17<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

Object o<span style=color:#f92672>;</span>
<span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>flag <span style=color:#f92672>&amp;</span> 8<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>primitiveAsString</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>asString<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            o <span style=color:#f92672>=</span> NativeHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>buf<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception var15<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>errorHandler</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>errorHandler</span><span style=color:#f92672>.</span><span style=color:#a6e22e>handleErrorOnGet</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> var15<span style=color:#f92672>,</span> key<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>

            log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;++++ Exception thrown while trying to deserialize for key: &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>,</span> var15<span style=color:#f92672>);</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NestedIOException<span style=color:#f92672>(</span>var15<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;++++ retrieving object and stuffing into a string.&#34;</span><span style=color:#f92672>);</span>
        o <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>(</span>buf<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultEncoding</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
    ContextObjectInputStream ois <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ContextObjectInputStream<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>buf<span style=color:#f92672>),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>classLoader</span><span style=color:#f92672>);</span>

    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
        o <span style=color:#f92672>=</span> ois<span style=color:#f92672>.</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>();</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;++++ deserializing &#34;</span> <span style=color:#f92672>+</span> o<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ClassNotFoundException var16<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>errorHandler</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>errorHandler</span><span style=color:#f92672>.</span><span style=color:#a6e22e>handleErrorOnGet</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> var16<span style=color:#f92672>,</span> key<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;++++ ClassNotFoundException thrown while trying to deserialize for key: &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>,</span> var16<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NestedIOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;+++ failed while trying to deserialize for key: &#34;</span> <span style=color:#f92672>+</span> key<span style=color:#f92672>,</span> var16<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>第一步，如果flag与2!=0，说明原来的数据被压缩，需要先解压。这一步我们需要确保Python放进去的数据是没有经过压缩的。</p><p>第二步的流程比较复杂，用过分析，默认流程会调用<code>o = NativeHandler.decode(buf);</code>这一句。对应的方法为<code>decode</code>，其中b[0]==6就是作为字符串解析。这样的话我们只需要Python在放入数据的时候使用相同的方式即可！</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Object <span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> b<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>&lt;</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 2<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeBoolean<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 3<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeInteger<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 6<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeString<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 5<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeCharacter<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeByte<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 7<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeStringBuffer<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 9<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeShort<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 4<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeLong<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 10<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeDouble<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 8<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> decodeFloat<span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> b<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> 11 <span style=color:#f92672>?</span> decodeDate<span style=color:#f92672>(</span>b<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>于是，下面的代码应运而生，完美解决问题，保持了数据兼容性！</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join([bytes([<span style=color:#ae81ff>6</span>]), str<span style=color:#f92672>.</span>encode(data)])
</code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://phpgao.github.io/tags/memcache/>memcache</a></li><li><a href=https://phpgao.github.io/tags/flag/>flag</a></li><li><a href=https://phpgao.github.io/tags/danga/>danga</a></li></ul><nav class=paginav><a class=prev href=https://phpgao.github.io/goproxy.html><span class=title>« Prev Page</span><br><span>golang的goproxy</span></a>
<a class=next href=https://phpgao.github.io/homebrew_boost.html><span class=title>Next Page »</span><br><span>国内加速Homebrew</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://phpgao.github.io/>老高的技术博客</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>